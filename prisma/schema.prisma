// USMax NDA Management System - Prisma Schema
// Story 1.2: JWT Middleware & User Context
//
// Database schema for authorization:
// - contacts (users)
// - roles, permissions, role_permissions (RBAC)
// - contact_roles (user-role assignment)
// - agency_groups, subagencies (organizational structure)
// - agency_group_grants, subagency_grants (data access control)
// - audit_log (compliance logging)

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// USERS/CONTACTS
// ============================================================================

/// Contact represents a user in the system (USMax staff member)
model Contact {
  id             String    @id @default(uuid())
  cognitoId      String?   @unique @map("cognito_id") // AWS Cognito sub claim (null if not yet linked)
  email          String    @unique
  firstName      String?   @map("first_name")
  lastName       String?   @map("last_name")
  workPhone      String?   @map("work_phone")
  cellPhone      String?   @map("cell_phone")
  fax            String?   // Fax number for external contacts
  jobTitle       String?   @map("job_title")
  active         Boolean   @default(true) // Soft delete flag
  isInternal     Boolean   @default(false) @map("is_internal") // Story 3.14: True for USMax employees
  emailSignature String?   @map("email_signature") @db.Text // Story 3.14: Email signature for internal users
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  contactRoles       ContactRole[]
  agencyGroupGrants  AgencyGroupGrant[]
  subagencyGrants    SubagencyGrant[]

  // Audit trail relations (who granted access)
  grantedContactRoles       ContactRole[]       @relation("GrantedBy")
  grantedAgencyGroupGrants  AgencyGroupGrant[]  @relation("GrantedBy")
  grantedSubagencyGrants    SubagencyGrant[]    @relation("GrantedBy")

  // Audit logs created by this user
  auditLogs AuditLog[]

  // NDA relations (Story 3.1)
  ndasCreated           Nda[]              @relation("NdaCreatedBy")
  ndasAsOpportunityPoc  Nda[]              @relation("NdaOpportunityPoc")
  ndasAsContractsPoc    Nda[]              @relation("NdaContractsPoc")
  ndasAsRelationshipPoc Nda[]              @relation("NdaRelationshipPoc")
  ndasAsContactsPoc     Nda[]              @relation("NdaContactsPoc")
  ndaStatusChanges      NdaStatusHistory[]
  documentsUploaded     Document[]

  // Email relations (Story 3.10)
  emailsSent            NdaEmail[]

  // Notification relations (Story 3.11)
  notificationPreference NotificationPreference?
  ndaSubscriptions       NdaSubscription[]

  // Template relations (Story 3.13)
  rtfTemplatesCreated    RtfTemplate[]

  @@map("contacts")
}

// ============================================================================
// RBAC - ROLES & PERMISSIONS
// ============================================================================

/// Role defines a set of permissions that can be assigned to users
model Role {
  id           String   @id @default(uuid())
  name         String   @unique // e.g., "Admin", "NDA User", "Limited User", "Read-Only"
  description  String?
  isSystemRole Boolean  @default(false) @map("is_system_role") // Cannot delete system roles
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]
  contactRoles    ContactRole[]

  @@map("roles")
}

/// Permission represents a specific action that can be performed
model Permission {
  id          String   @id @default(uuid())
  code        String   @unique // e.g., "nda:create", "admin:manage_users"
  name        String   // Human-readable name
  description String?
  category    String   // "nda" or "admin"
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@map("permissions")
}

/// RolePermission is a junction table linking roles to their permissions
model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

/// ContactRole assigns roles to users
model ContactRole {
  contactId  String    @map("contact_id")
  roleId     String    @map("role_id")
  grantedBy  String?   @map("granted_by") // Who assigned this role
  grantedAt  DateTime  @default(now()) @map("granted_at")

  contact      Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  role         Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  grantedByUser Contact? @relation("GrantedBy", fields: [grantedBy], references: [id])

  @@id([contactId, roleId])
  @@map("contact_roles")
}

// ============================================================================
// AGENCY STRUCTURE
// ============================================================================

/// AgencyGroup represents a high-level organizational grouping (e.g., DoD, Commercial, Fed Civ)
model AgencyGroup {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "Department of Defense"
  code        String   @unique // e.g., "DoD"
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  subagencies        Subagency[]
  agencyGroupGrants  AgencyGroupGrant[]
  ndas               Nda[]
  rtfTemplates       RtfTemplate[]

  @@map("agency_groups")
}

/// Subagency represents a specific agency within a group (e.g., Air Force within DoD)
model Subagency {
  id            String   @id @default(uuid())
  agencyGroupId String   @map("agency_group_id")
  name          String   // e.g., "US Air Force"
  code          String   // e.g., "USAF"
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  agencyGroup     AgencyGroup      @relation(fields: [agencyGroupId], references: [id], onDelete: Restrict)
  subagencyGrants SubagencyGrant[]
  ndas            Nda[]

  @@unique([agencyGroupId, code])
  @@unique([agencyGroupId, name])
  @@map("subagencies")
}

// ============================================================================
// AGENCY ACCESS GRANTS
// ============================================================================

/// AgencyGroupGrant gives a user access to all subagencies within an agency group
model AgencyGroupGrant {
  id            String   @id @default(uuid())
  contactId     String   @map("contact_id")
  agencyGroupId String   @map("agency_group_id")
  grantedBy     String?  @map("granted_by")
  grantedAt     DateTime @default(now()) @map("granted_at")

  contact       Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  agencyGroup   AgencyGroup @relation(fields: [agencyGroupId], references: [id], onDelete: Cascade)
  grantedByUser Contact?    @relation("GrantedBy", fields: [grantedBy], references: [id])

  @@unique([contactId, agencyGroupId])
  @@map("agency_group_grants")
}

/// SubagencyGrant gives a user access to a specific subagency (more granular than group)
model SubagencyGrant {
  id          String   @id @default(uuid())
  contactId   String   @map("contact_id")
  subagencyId String   @map("subagency_id")
  grantedBy   String?  @map("granted_by")
  grantedAt   DateTime @default(now()) @map("granted_at")

  contact       Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  subagency     Subagency @relation(fields: [subagencyId], references: [id], onDelete: Cascade)
  grantedByUser Contact?  @relation("GrantedBy", fields: [grantedBy], references: [id])

  @@unique([contactId, subagencyId])
  @@map("subagency_grants")
}

// ============================================================================
// NDA - Story 3.1: Create NDA with Basic Form
// ============================================================================

/// NDA Status enum for lifecycle tracking
enum NdaStatus {
  CREATED
  EMAILED
  IN_REVISION
  FULLY_EXECUTED
  INACTIVE
  CANCELLED
}

/// USMax Position on the contract
enum UsMaxPosition {
  PRIME
  SUB
  TEAMING
  OTHER
}

/// NDA Type enum for classification and suggestions
enum NdaType {
  MUTUAL
  ONE_WAY_GOVERNMENT
  ONE_WAY_COUNTERPARTY
  VISITOR
  RESEARCH
  VENDOR_ACCESS
}

/// NDA represents a Non-Disclosure Agreement record
model Nda {
  id        String @id @default(uuid())
  displayId Int    @unique @default(autoincrement()) @map("display_id")

  // Company Information
  companyName          String  @map("company_name")
  companyCity          String? @map("company_city")
  companyState         String? @map("company_state")
  stateOfIncorporation String? @map("state_of_incorporation")

  // Agency Information (row-level security)
  agencyGroupId    String       @map("agency_group_id")
  agencyGroup      AgencyGroup  @relation(fields: [agencyGroupId], references: [id])
  subagencyId      String?      @map("subagency_id")
  subagency        Subagency?   @relation(fields: [subagencyId], references: [id])
  agencyOfficeName String?      @map("agency_office_name")

  // NDA Details
  ndaType            NdaType      @default(MUTUAL) @map("nda_type")
  abbreviatedName   String        @map("abbreviated_name")
  authorizedPurpose String        @map("authorized_purpose") @db.VarChar(255)
  effectiveDate     DateTime?     @map("effective_date")
  usMaxPosition     UsMaxPosition @default(PRIME) @map("usmax_position")
  isNonUsMax        Boolean       @default(false) @map("is_non_usmax")

  // Status
  status            NdaStatus @default(CREATED)
  fullyExecutedDate DateTime? @map("fully_executed_date")

  // POCs (Points of Contact)
  opportunityPocId  String   @map("opportunity_poc_id")
  opportunityPoc    Contact  @relation("NdaOpportunityPoc", fields: [opportunityPocId], references: [id])
  contractsPocId    String?  @map("contracts_poc_id")
  contractsPoc      Contact? @relation("NdaContractsPoc", fields: [contractsPocId], references: [id])
  relationshipPocId String   @map("relationship_poc_id")
  relationshipPoc   Contact  @relation("NdaRelationshipPoc", fields: [relationshipPocId], references: [id])
  contactsPocId     String?  @map("contacts_poc_id")
  contactsPoc       Contact? @relation("NdaContactsPoc", fields: [contactsPocId], references: [id])

  // Template Selection
  rtfTemplateId String?      @map("rtf_template_id")
  rtfTemplate   RtfTemplate? @relation(fields: [rtfTemplateId], references: [id])

  // Clone tracking
  clonedFromId String? @map("cloned_from_id")
  clonedFrom   Nda?    @relation("NdaClone", fields: [clonedFromId], references: [id])
  clones       Nda[]   @relation("NdaClone")

  // Metadata
  createdById String   @map("created_by_id")
  createdBy   Contact  @relation("NdaCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  statusHistory NdaStatusHistory[]
  documents     Document[]
  emails        NdaEmail[]
  subscriptions NdaSubscription[]

  @@index([agencyGroupId])
  @@index([subagencyId])
  @@index([status])
  @@index([companyName])
  @@index([createdById])
  @@index([effectiveDate])
  @@index([rtfTemplateId])
  @@map("ndas")
}

/// NdaStatusHistory tracks status changes for visual progression
model NdaStatusHistory {
  id          String    @id @default(uuid())
  ndaId       String    @map("nda_id")
  nda         Nda       @relation(fields: [ndaId], references: [id], onDelete: Cascade)
  status      NdaStatus
  changedAt   DateTime  @default(now()) @map("changed_at")
  changedById String    @map("changed_by_id")
  changedBy   Contact   @relation(fields: [changedById], references: [id])

  @@index([ndaId])
  @@map("nda_status_history")
}

/// Document type enum
enum DocumentType {
  GENERATED
  UPLOADED
  FULLY_EXECUTED
}

/// Document represents files attached to an NDA
/// Story 4.1-4.7: Document Management & Execution
model Document {
  id             String       @id @default(uuid())
  ndaId          String       @map("nda_id")
  nda            Nda          @relation(fields: [ndaId], references: [id], onDelete: Cascade)
  filename       String       // Original filename
  s3Key          String       @map("s3_key")
  s3Region       String       @default("us-east-1") @map("s3_region")
  fileType       String?      @map("file_type") // MIME type (e.g., application/pdf)
  fileSize       Int?         @map("file_size") // File size in bytes
  documentType   DocumentType @default(UPLOADED) @map("document_type")
  isFullyExecuted Boolean     @default(false) @map("is_fully_executed") // Story 4.2
  isEdited       Boolean      @default(false) @map("is_edited") // Story 3.13
  versionNumber  Int          @default(1) @map("version_number") // Story 4.4
  notes          String?      @db.Text // Story 4.6: metadata notes
  uploadedById   String       @map("uploaded_by_id")
  uploadedBy     Contact      @relation(fields: [uploadedById], references: [id])
  uploadedAt     DateTime     @default(now()) @map("uploaded_at")

  @@index([ndaId])
  @@index([documentType])
  @@index([isFullyExecuted])
  @@map("documents")
}

// ============================================================================
// EMAIL - Story 3.10: Email Composition & Sending
// ============================================================================

/// Email status for tracking delivery
enum EmailStatus {
  QUEUED
  SENT
  FAILED
  DELIVERED
  BOUNCED
}

/// NdaEmail represents emails sent for an NDA
model NdaEmail {
  id            String      @id @default(uuid())
  ndaId         String      @map("nda_id")
  nda           Nda         @relation(fields: [ndaId], references: [id], onDelete: Cascade)
  subject       String
  toRecipients  String[]    @map("to_recipients")
  ccRecipients  String[]    @map("cc_recipients")
  bccRecipients String[]    @map("bcc_recipients")
  body          String      @db.Text
  templateId    String?     @map("template_id")
  template      EmailTemplate? @relation(fields: [templateId], references: [id])
  sentAt        DateTime    @default(now()) @map("sent_at")
  sentById      String      @map("sent_by_id")
  sentBy        Contact     @relation(fields: [sentById], references: [id])
  sesMessageId  String?     @map("ses_message_id")
  status        EmailStatus @default(QUEUED)
  retryCount    Int         @default(0) @map("retry_count")
  lastError     String?     @map("last_error")

  @@index([ndaId])
  @@index([status])
  @@map("nda_emails")
}

/// EmailTemplate stores email composition templates
model EmailTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  subject     String
  body        String   @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  emails      NdaEmail[]

  @@index([isDefault])
  @@index([isActive])
  @@map("email_templates")
}

// ============================================================================
// NOTIFICATIONS - Story 3.11: Email Notifications to Stakeholders
// ============================================================================

/// NotificationPreference stores user preferences for notification events
model NotificationPreference {
  id               String  @id @default(uuid())
  contactId        String  @unique @map("contact_id")
  contact          Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Event toggles
  onNdaCreated     Boolean @default(true) @map("on_nda_created")
  onNdaEmailed     Boolean @default(true) @map("on_nda_emailed")
  onDocumentUploaded Boolean @default(true) @map("on_document_uploaded")
  onStatusChanged  Boolean @default(true) @map("on_status_changed")
  onFullyExecuted  Boolean @default(true) @map("on_fully_executed")

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

/// NdaSubscription tracks which users are subscribed to notifications for specific NDAs
model NdaSubscription {
  id        String   @id @default(uuid())
  ndaId     String   @map("nda_id")
  nda       Nda      @relation(fields: [ndaId], references: [id], onDelete: Cascade)
  contactId String   @map("contact_id")
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([ndaId, contactId])
  @@index([ndaId])
  @@index([contactId])
  @@map("nda_subscriptions")
}

// ============================================================================
// TEMPLATES - Story 3.13: RTF Template Selection & Preview
// ============================================================================

/// RtfTemplate stores RTF document templates for NDA generation
model RtfTemplate {
  id            String       @id @default(uuid())
  name          String       // Display name
  description   String?      // Optional description
  content       Bytes        // RTF template content
  agencyGroupId String?      @map("agency_group_id") // null = generic template
  agencyGroup   AgencyGroup? @relation(fields: [agencyGroupId], references: [id])
  isDefault     Boolean      @default(false) @map("is_default")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  createdById   String?      @map("created_by_id")
  createdBy     Contact?     @relation(fields: [createdById], references: [id])
  ndas          Nda[]

  @@index([agencyGroupId])
  @@index([isActive])
  @@map("rtf_templates")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

/// AuditLog tracks all significant actions in the system for compliance
model AuditLog {
  id          String   @id @default(uuid())
  action      String   // e.g., "login_success", "nda_created", "permission_denied"
  entityType  String   @map("entity_type") // e.g., "authentication", "nda", "user"
  entityId    String?  @map("entity_id") // ID of the affected entity (if applicable)
  userId      String?  @map("user_id") // User who performed the action
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  details     Json?    // Additional context as JSON
  createdAt   DateTime @default(now()) @map("created_at")

  user Contact? @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_log")
}

// ============================================================================
// SYSTEM CONFIGURATION
// ============================================================================

/// SystemConfig stores key-value configuration pairs for system-wide settings
/// Epic 7, Stories 7.14-7.19: Admin Configuration
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique // Configuration key (e.g., "dashboard.stale_days")
  value     String   @db.Text // Configuration value (JSON for complex values)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([key])
  @@map("system_config")
}
